; Helper functions

spacer: "        "

supersection: function [title][
    cl: #magenta
    print ""
    print color cl repeat "*" 50
    print color cl "*"
    print color cl "* " ++ title
    print color cl "*"
    print color cl repeat "*" 50
]

topic: function [title][
    print ""
    print spacer ++ ">" ++ repeat "-" 50
    print spacer ++ "> " ++ color.bold #white title
    print spacer ++ ">" ++ repeat "-" 50
    print ""
]

byteCode: function [blk][
    btc: to.intrepid :bytecode blk ; this little hack is needed to remove newlines from our block
                                ; thus, avoiding all opEol/opEolX bytecode being produced

    ;inspect btc    ; uncomment this line to see the bytecode
                    ; in a more readable format
    prints spacer
    print ["input:" as.code blk]
    prints spacer
    print ["data:" get btc 'data]
    prints spacer
    cd: get btc 'code
    print ["code:" cd "(" ++ (to :string size cd) ++ " bytes)"]
    print ""
]

; Main unit-tests

;/////////////////////////////////////////////////////////
supersection "SIMPLE VALUES"
;/////////////////////////////////////////////////////////

    ;*****************************************************************
    topic "Boolean"
    ;*******************************************Ã¥**********************

        byteCode [true]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; constbt
        ; end

        byteCode [false]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; constbf
        ; end

        byteCode [maybe]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: maybe :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; end

    ;*****************************************************************
    topic "Integer"
    ;*****************************************************************

        byteCode [1]
        ; ================================
        ;     DATA
        ; ================================

        ; ================================
        ;     CODE
        ; ================================
        ; consti1
        ; end

        byteCode [10]
        ; ================================
        ;     DATA
        ; ================================

        ; ================================
        ;     CODE
        ; ================================
        ; consti10
        ; end

        byteCode [123]
        ; ================================
        ;     DATA
        ; ================================
        ; 0: 123 :integer

        ; ================================
        ;     CODE
        ; ================================
        ; push0
        ; end

        byteCode [1234567890123]
        ; ================================
        ;     DATA
        ; ================================
        ; 0: 1234567890123 :integer

        ; ================================
        ;     CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Floating"
    ;*****************************************************************

        byteCode [0.0]
        ; ================================
        ;     DATA
        ; ================================

        ; ================================
        ;     CODE
        ; ================================
        ; constf0
        ; end

        byteCode [1.0]
        ; ================================
        ;     DATA
        ; ================================

        ; ================================
        ;     CODE
        ; ================================
        ; constf1
        ; end

        byteCode [10.0]
        ; ================================
        ;     DATA
        ; ================================
        ; 0: 10.0 :floating

        ; ================================
        ;     CODE
        ; ================================
        ; push0
        ; end

        byteCode [12345.1234567]
        ; ================================
        ;     DATA
        ; ================================
        ; 0: 12345.1234567 :floating

        ; ================================
        ;     CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Char"
    ;*****************************************************************

        byteCode ['a']
        ; ================================
        ;  DATA
        ; ================================
        ; 0: a :char

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode ['ðŸ˜€']
        ; ================================
        ;  DATA
        ; ================================
        ; 0: ðŸ˜€ :char

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "String"
    ;*****************************************************************

        byteCode [""]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consts
        ; end

        byteCode ["Hello World!"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: Hello World! :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Regex"
    ;*****************************************************************

        byteCode [{/hello/}]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: hello :regex

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode [{/[A-Z]+\d/}]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [A-Z]+\d :regex

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Type"
    ;*****************************************************************

        byteCode [:integer]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: integer :type

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode [:string]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: string :type

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Literal"
    ;*****************************************************************

        byteCode ['a]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: a :literal

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode ['a 'b 'c]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: a :literal
        ; 1: b :literal
        ; 2: c :literal

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; push2
        ; end

    ;*****************************************************************
    topic "SymbolLiteral"
    ;*****************************************************************

        byteCode ['+]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: + :symbolliteral

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode ['-->]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: --> :symbolliteral

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Color"
    ;*****************************************************************

        byteCode [#red]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: #FF0000 :color

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode [#00FF66]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: #00FF66 :color

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Quantity"
    ;*****************************************************************

        byteCode [1`s]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 1:1`s :quantity

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode [12`m]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 12:1 m :quantity

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Version"
    ;*****************************************************************

        byteCode [0.9.82]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 0.9.82 :version

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode [2.0.0-rc1]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 2.0.0-rc1 :version

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Block"
    ;*****************************************************************

        byteCode [[]]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consta
        ; end

        byteCode [[1 "hello" 3.14 true]]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         1 :integer
        ;         hello :string
        ;         3.14 :floating
        ;         true :word
        ; ]

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "Null"
    ;*****************************************************************

        byteCode [Ã¸]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; constn
        ; end

        byteCode [null]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: null :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; end

;/////////////////////////////////////////////////////////
supersection "LABELS"
;/////////////////////////////////////////////////////////

    ;*****************************************************************
    topic "Setting and getting variables"
    ;*****************************************************************

        byteCode [
            a: 1
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: a :label

        ; ================================
        ;  CODE
        ; ================================
        ; consti1
        ; store0
        ; end

        byteCode [
            b: 2
            c: b
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: b :label
        ; 1: c :label

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; store0
        ; load0
        ; store1
        ; end

;/////////////////////////////////////////////////////////
supersection "FUNCTION CALLS"
;/////////////////////////////////////////////////////////

    ;*****************************************************************
    topic "Built-in function calls"
    ;*****************************************************************

        byteCode [abs 10]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: abs :word

        ; ================================
        ;  CODE
        ; ================================
        ; consti10
        ; call0
        ; end

        byteCode [empty? []]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: empty? :word

        ; ================================
        ;  CODE
        ; ================================
        ; consta
        ; call0
        ; end

        byteCode [couple [1 2] ["one" "two"]]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         one :string
        ;         two :string
        ; ]
        ; 1: [ :block
        ;         1 :integer
        ;         2 :integer
        ; ]
        ; 2: couple :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; call2
        ; end

    ;*****************************************************************
    topic "Opcoded built-in function calls"
    ;*****************************************************************

        byteCode [print 2]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; print
        ; end

        byteCode [size [1 2]]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         1 :integer
        ;         2 :integer
        ; ]

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; size
        ; end

        byteCode [and 1 123]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 123 :integer

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; consti1
        ; band
        ; end

    ;*****************************************************************
    topic "Composite opcoded built-in function calls"
    ;*****************************************************************

        byteCode [to :floating 1]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: floating :type

        ; ================================
        ;  CODE
        ; ================================
        ; consti1
        ; push0
        ; to
        ; end

        byteCode [to :integer "10"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 10 :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; toi
        ; end

        byteCode [to :string 5]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti5
        ; tos
        ; end

    ;*****************************************************************
    topic "Function calls with attributes"
    ;*****************************************************************

        byteCode [split.words "hello world"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: hello world :string
        ; 1: words :attribute

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; constbt
        ; attr1
        ; split
        ; end

        byteCode [split.by:"X" "helloXworld"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: helloXworld :string
        ; 1: X :string
        ; 2: by :attributelabel

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; attr2
        ; split
        ; end

        byteCode [join.with:"-" ["hello" "world"]]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         hello :string
        ;         world :string
        ; ]
        ; 1: - :string
        ; 2: with :attributelabel

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; attr2
        ; join
        ; end

    ;*****************************************************************
    topic "Function calls via symbol aliases"
    ;*****************************************************************

        byteCode [@[1 2 3]]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         1 :integer
        ;         2 :integer
        ;         3 :integer
        ; ]

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; array
        ; end

        byteCode ["hello " ++ x]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: x :word
        ; 1: hello  :string

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; push1
        ; append
        ; end

        byteCode [1..25]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 25 :integer

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; consti1
        ; range
        ; end

    ;*****************************************************************
    topic "User function definition & calling"
    ;*****************************************************************

        byteCode [
            h: function [][print "function called"]

            print "before"
            h
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         print :word
        ;         function called :string
        ; ]
        ; 1: h :label
        ; 2: before :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; consta
        ; func
        ; store1
        ; push2
        ; print
        ; call1
        ; push3
        ; print
        ; end

        byteCode [
            f: function [x][x + 1]

            print "before"
            print f 10
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         x :word
        ;         + :symbol
        ;         1 :integer
        ; ]
        ; 1: [ :block
        ;         x :word
        ; ]
        ; 2: f :label
        ; 3: before :string
        ; 4: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; func
        ; store2
        ; push3
        ; print
        ; consti10
        ; call2
        ; print
        ; push4
        ; print
        ; end

        byteCode [
            g: $[z w][2 * z * w]

            print "before"
            print g 10 20
            print "after"
        ]

        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         2 :integer
        ;         * :symbol
        ;         z :word
        ;         * :symbol
        ;         w :word
        ; ]
        ; 1: [ :block
        ;         z :word
        ;         w :word
        ; ]
        ; 2: g :label
        ; 3: before :string
        ; 4: 20 :integer
        ; 5: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; func
        ; store2
        ; push3
        ; print
        ; push4
        ; consti10
        ; call2
        ; print
        ; push5
        ; print
        ; end

;/////////////////////////////////////////////////////////
supersection "PATHS"
;/////////////////////////////////////////////////////////

    ;*****************************************************************
    topic "Path values"
    ;*****************************************************************
        
        byteCode [a\0]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: a :word

        ; ================================
        ;  CODE
        ; ================================
        ; consti0
        ; load0
        ; get
        ; end

        byteCode [user\name]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: name :literal
        ; 1: user :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; load1
        ; get
        ; end

        byteCode [user\grades\0]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: grades :literal
        ; 1: user :word

        ; ================================
        ;  CODE
        ; ================================
        ; consti0
        ; push0
        ; load1
        ; get
        ; get
        ; end

        byteCode [user\address\country]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: country :literal
        ; 1: address :literal
        ; 2: user :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; load2
        ; get
        ; get
        ; end

    ;*****************************************************************
    topic "PathLabel values"
    ;*****************************************************************

        byteCode [a\0: 10]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: a :word

        ; ================================
        ;  CODE
        ; ================================
        ; consti10
        ; consti0
        ; load0
        ; set
        ; end

        byteCode [user\name: "John"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: John :string
        ; 1: name :literal
        ; 2: user :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; load2
        ; set
        ; end

        byteCode [user\grades\0: 6]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: grades :literal
        ; 1: user :word

        ; ================================
        ;  CODE
        ; ================================
        ; consti6
        ; consti0
        ; push0
        ; load1
        ; get
        ; set
        ; end

        byteCode [user\address\country: "USA"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: USA :string
        ; 1: country :literal
        ; 2: address :literal
        ; 3: user :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; push2
        ; load3
        ; get
        ; set
        ; end

;/////////////////////////////////////////////////////////
supersection "BLOCKS & SYNTACTIC SUGAR"
;/////////////////////////////////////////////////////////

    ;*****************************************************************
    topic "Inline blocks"
    ;*****************************************************************

        byteCode [(print 2)]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; print
        ; end

        byteCode [(print 2) (print 3)]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; print
        ; consti3
        ; print
        ; end

        byteCode [(print 2 print 3)]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; print
        ; consti3
        ; print
        ; end

    ;*****************************************************************
    topic "doublecolon syntactic sugar (`::`)"
    ;*****************************************************************

        byteCode [
            print 2
            do :: 
                print 3
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         print :word
        ;         3 :integer
        ; ]
        ; 1: do :word

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; print
        ; push0
        ; call1
        ; end

    ;*****************************************************************
    topic "arrowright syntactic sugar (`->`)"
    ;*****************************************************************

        byteCode [-> "hello"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         hello :string
        ; ]

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode [
            do -> print "hello"
            print "done"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         print :word
        ;         hello :string
        ; ]
        ; 1: do :word
        ; 2: done :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; call1
        ; push2
        ; print
        ; end

        byteCode [-> 1 -> 2]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         1 :integer
        ; ]
        ; 1: [ :block
        ;         2 :integer
        ; ]

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; end

        byteCode [
            a: -> upper "hello"
            b: -> "hello " ++ world
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         upper :word
        ;         hello :string
        ; ]
        ; 1: a :label
        ; 2: [ :block
        ;         hello  :string
        ;         ++ :symbol
        ;         world :word
        ; ]
        ; 3: b :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; store1
        ; push2
        ; store3
        ; end

    ;*****************************************************************
    topic "thickarrowright syntactic sugar (`=>`)"
    ;*****************************************************************

        byteCode [=> "hello"]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         hello :string
        ; ]

        ; ================================
        ;  CODE
        ; ================================
        ; consta
        ; push0
        ; end

        byteCode [
            f: function => print
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         print :word
        ;         _0 :word
        ; ]
        ; 1: _0 :literal
        ; 2: f :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; func
        ; store2
        ; end

        byteCode [
            adder: $ => add
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         add :word
        ;         _0 :word
        ;         _1 :word
        ; ]
        ; 1: [ :block
        ;         _0 :word
        ;         _1 :word
        ; ]
        ; 2: adder :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; func
        ; store2
        ; end

        byteCode [
            subOne: function => [& - 1]
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         _0 :word
        ;         - :symbol
        ;         1 :integer
        ; ]
        ; 1: _0 :literal
        ; 2: subOne :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; func
        ; store2
        ; end

        byteCode [
            mulAddOne: $ => [1 + & * &]
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         1 :integer
        ;         + :symbol
        ;         _0 :word
        ;         * :symbol
        ;         _1 :word
        ; ]
        ; 1: [ :block
        ;         _0 :word
        ;         _1 :word
        ; ]
        ; 2: mulAddOne :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; func
        ; store2
        ; end

    ;*****************************************************************
    topic "pipe operator (`|`)"
    ;*****************************************************************

        byteCode [2 | print]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; print
        ; end

        byteCode ["hello" | upper | print]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: hello :string
        ; 1: upper :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; call1
        ; print
        ; end

        byteCode [x: "hello" | upper]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: hello :string
        ; 1: upper :word
        ; 2: x :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; call1
        ; store2
        ; end

        byteCode [1..10 | map 'x -> 2 * x]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         2 :integer
        ;         * :symbol
        ;         x :word
        ; ]
        ; 1: x :literal

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; consti10
        ; consti1
        ; range
        ; map
        ; end

        byteCode [1..10 | map 'x -> 2 * x | sum]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         2 :integer
        ;         * :symbol
        ;         x :word
        ; ]
        ; 1: x :literal
        ; 2: sum :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; consti10
        ; consti1
        ; range
        ; map
        ; call2
        ; end

        byteCode [1..10 | map 'x -> 2 * x | sum | print]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         2 :integer
        ;         * :symbol
        ;         x :word
        ; ]
        ; 1: x :literal
        ; 2: sum :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; consti10
        ; consti1
        ; range
        ; map
        ; call2
        ; print
        ; end

        byteCode [
            1..10 | map 'x -> 2 * x 
                  | sum 
                  | print
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         2 :integer
        ;         * :symbol
        ;         x :word
        ; ]
        ; 1: x :literal
        ; 2: sum :word

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; consti10
        ; consti1
        ; range
        ; map
        ; call2
        ; print
        ; end

        byteCode [
            filtered: 1..a | map 'x -> 3 * x
                           | select 'x -> odd? x
            print filtered
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         odd? :word
        ;         x :word
        ; ]
        ; 1: x :literal
        ; 2: [ :block
        ;         3 :integer
        ;         * :symbol
        ;         x :word
        ; ]
        ; 3: a :word
        ; 4: filtered :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; push2
        ; push1
        ; load3
        ; consti1
        ; range
        ; map
        ; select
        ; storl4
        ; print
        ; end

        byteCode [
            filtered: 1..a | map 'x -> 3 * x
                           | select => odd?
            print filtered
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         odd? :word
        ;         _0 :word
        ; ]
        ; 1: _0 :literal
        ; 2: [ :block
        ;         3 :integer
        ;         * :symbol
        ;         x :word
        ; ]
        ; 3: x :literal
        ; 4: a :word
        ; 5: filtered :label

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; push1
        ; push2
        ; push3
        ; load4
        ; consti1
        ; range
        ; map
        ; select
        ; storl5
        ; print
        ; end

;/////////////////////////////////////////////////////////
supersection "OPTIMIZATIONS"
;/////////////////////////////////////////////////////////

    ;*****************************************************************
    topic "add (`+`) / constant folding"
    ;*****************************************************************

        byteCode [add 2 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti5
        ; end

        byteCode [2 + 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti5
        ; end

        byteCode [2 + 3 + 4 + 5]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti14
        ; end


        byteCode [1 + 2 + 3 + 4 + 5 + 6]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 21 :integer

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

        byteCode [x: 3 + 7]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: x :label

        ; ================================
        ;  CODE
        ; ================================
        ; consti10
        ; store0
        ; end

    ;*****************************************************************
    topic "add (`+`) / -> inc"
    ;*****************************************************************

        byteCode [x + 1]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: x :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; inc
        ; end

        byteCode [1 + y]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: y :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; inc
        ; end

    ;*****************************************************************
    topic "add (`+`) / distributive"
    ;*****************************************************************

        byteCode [X + X * Y]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: Y :word
        ; 1: X :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; consti1
        ; add
        ; load1
        ; mul
        ; end

        byteCode [(X * Y) + X]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: X :word
        ; 1: Y :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; load1
        ; consti1
        ; add
        ; mul
        ; end

    ;*****************************************************************
    topic "sub (`-`) / constant folding"
    ;*****************************************************************

        byteCode [sub 2 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti1m
        ; end

        byteCode [2 - 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti1m
        ; end

        byteCode [8 - 2 - 1]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti7
        ; end

        byteCode [30 - 10 - 1]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 21 :integer

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "sub (`-`) / -> dec"
    ;*****************************************************************

        byteCode [x - 1]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: x :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; dec
        ; end

    ;*****************************************************************
    topic "mul (`*`) / constant folding"
    ;*****************************************************************

        byteCode [mul 2 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti6
        ; end

        byteCode [2 * 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti6
        ; end

        byteCode [2 * 2 * 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti12
        ; end

        byteCode [2 * 3 * 4 * 5]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 120 :integer

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "div (`/`) / constant folding"
    ;*****************************************************************

        byteCode [div 6 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; end

        byteCode [6 / 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; end

        byteCode [6 / 6 / 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti3
        ; end

        byteCode [50 / 4 / 4 / 2]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 25 :integer

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "fdiv (`//`) / constant folding"
    ;*****************************************************************

        byteCode [fdiv 6 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; constf2
        ; end

        byteCode [6 // 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; constf2
        ; end

        byteCode [4 // 8 // 2]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; constf1
        ; end

        byteCode [55 // 4 // 4 // 2]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 27.5 :floating

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "mod (`%`) / constant folding"
    ;*****************************************************************

        byteCode [mod 6 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti0
        ; end

        byteCode [6 % 3]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti0
        ; end

        byteCode [20 % 15 % 6]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti2
        ; end

    ;*****************************************************************
    topic "pow (`^`) / constant folding"
    ;*****************************************************************

        byteCode [pow 3 2]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti9
        ; end

        byteCode [3 ^ 2]
        ; ================================
        ;  DATA
        ; ================================

        ; ================================
        ;  CODE
        ; ================================
        ; consti9
        ; end

        byteCode [2 ^ 2 ^ 2]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: 16 :integer

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; end

    ;*****************************************************************
    topic "if"
    ;*****************************************************************

        byteCode [
            print "before"
            if x [print "here", return true]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; load1
        ; jmpifnot             @4
        ; push2
        ; print
        ; constbt
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            if not? x [print "here", return false]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; load1
        ; jmpif                @4
        ; push2
        ; print
        ; constbf
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            if x=2 [print "here", return true]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; consti2
        ; load1
        ; jmpifne              @4
        ; push2
        ; print
        ; constbt
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            if x>2 [print "here", return true]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; consti2
        ; load1
        ; jmpifle              @4
        ; push2
        ; print
        ; constbt
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            if x=<2 [print "here", return true]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; consti2
        ; load1
        ; jmpifgt              @4
        ; push2
        ; print
        ; constbt
        ; return
        ; push3
        ; print
        ; end

    ;*****************************************************************
    topic "unless"
    ;*****************************************************************

        byteCode [
            print "before"
            unless x [print "here", return false]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; load1
        ; jmpif                @4
        ; push2
        ; print
        ; constbf
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            unless not? x [print "here", return true]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; load1
        ; jmpifnot             @4
        ; push2
        ; print
        ; constbt
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            unless x=2 [print "here", return false]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; consti2
        ; load1
        ; jmpifeq              @4
        ; push2
        ; print
        ; constbf
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            unless x>2 [print "here", return false]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; consti2
        ; load1
        ; jmpifgt              @4
        ; push2
        ; print
        ; constbf
        ; return
        ; push3
        ; print
        ; end

        byteCode [
            print "before"
            unless x=<2 [print "here", return false]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: x :word
        ; 2: here :string
        ; 3: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; consti2
        ; load1
        ; jmpifle              @4
        ; push2
        ; print
        ; constbf
        ; return
        ; push3
        ; print
        ; end

    ;*****************************************************************
    topic "if?-else"
    ;*****************************************************************

        byteCode [
            if? x [return true]
            else [return false]
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: x :word

        ; ================================
        ;  CODE
        ; ================================
        ; load0
        ; jmpifnot             @4
        ; constbt
        ; return
        ; goto                 @2
        ; constbf
        ; return
        ; end

        byteCode [
            print "before"
            if? a <> 1 + 2 [print "here", return true]
            else [print "there", return false]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: a :word
        ; 2: here :string
        ; 3: there :string
        ; 4: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; consti3
        ; load1
        ; jmpifeq              @6
        ; push2
        ; print
        ; constbt
        ; return
        ; goto                 @4
        ; push3
        ; print
        ; constbf
        ; return
        ; push4
        ; print
        ; end

    ;*****************************************************************
    topic "switch (`?`)"
    ;*****************************************************************

        byteCode [
            print "before"
            switch a [1][2]
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: a :word
        ; 2: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; load1
        ; jmpifnot             @3
        ; consti1
        ; goto                 @1
        ; consti2
        ; push2
        ; print
        ; end

        byteCode [(x = 1)? -> 1 -> 2]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: x :word

        ; ================================
        ;  CODE
        ; ================================
        ; consti1
        ; load0
        ; jmpifne              @3
        ; consti1
        ; goto                 @1
        ; consti2
        ; end

        byteCode [
            print "before"
            return (x<1)? -> true -> false
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: [ :block
        ;         false :word
        ; ]
        ; 2: [ :block
        ;         true :word
        ; ]
        ; 3: x :word
        ; 4: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; push1
        ; push2
        ; consti1
        ; load3
        ; lt
        ; switch
        ; return
        ; push4
        ; print
        ; end

        byteCode [
            print "before"
            z: (x<1)? -> true -> false
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: [ :block
        ;         false :word
        ; ]
        ; 2: [ :block
        ;         true :word
        ; ]
        ; 3: x :word
        ; 4: z :label
        ; 5: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; push1
        ; push2
        ; consti1
        ; load3
        ; lt
        ; switch
        ; store4
        ; push5
        ; print
        ; end

        byteCode [
            print "before"
            z: 3 + (x>=1)? -> 1 -> 2
            print "after"
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: before :string
        ; 1: [ :block
        ;         2 :integer
        ; ]
        ; 2: [ :block
        ;         1 :integer
        ; ]
        ; 3: x :word
        ; 4: z :label
        ; 5: after :string

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; print
        ; push1
        ; push2
        ; consti1
        ; load3
        ; ge
        ; switch
        ; consti3
        ; add
        ; store4
        ; push5
        ; print
        ; end

    ;*****************************************************************
    topic "while"
    ;*****************************************************************

        byteCode [
            while [x=1][print "hello"]
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: x :word
        ; 1: hello :string

        ; ================================
        ;  CODE
        ; ================================
        ; consti1
        ; load0
        ; jmpifne              @4
        ; push1
        ; print
        ; goup                 @6
        ; end

        byteCode [
            while Ã¸ [print "hello"]
        ]
        ; ================================
        ;  DATA
        ; ================================
        ; 0: [ :block
        ;         print :word
        ;         hello :string
        ; ]

        ; ================================
        ;  CODE
        ; ================================
        ; push0
        ; constn
        ; while
        ; end