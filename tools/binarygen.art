#!/usr/bin/env arturo
                
;================================
; Prepare binaries data structure
;================================

; Platform order
platforms: #[
    linux: "Linux"
    macos: "macOS"
    windows: "Windows"
    freebsd: "FreeBSD"
    web: "Web"
]

; Initialize result structure
binaries: #[]

; Process all binary zip files
loop sort list "files" 'filename [
    print ["Processing file:" filename]
    if suffix? filename ".zip" [
        artifactName: extract.filename filename
        
        ; Only process arturo-* files
        if prefix? artifactName "arturo-" [
            print ["Processing:" artifactName]
            
            ; Get size
            lsOutput: execute ~"ls -lh |filename|"
            fileSize: get split.words lsOutput 4

            ; Get checksum  
            checksumOutput: execute ~"sha256sum |filename|"
            checksum: first split.words checksumOutput
            
            ; Parse artifact name: arturo-VERSION-OS-ARCH[-MODE][-legacy]
            allParts: split.by: "-" artifactName
            parts: drop.times: 2 allParts
            
            os: translate first parts platforms
            
            arch: get parts 1
            mode: "full"
            legacy: false
            
            ; Check for mode/legacy in remaining parts
            if 2 < size parts [
                thirdPart: get parts 2
                inspect thirdPart
                switch contains? ["mini" "safe"] thirdPart [
                    mode: thirdPart
                    if 3 < size parts [
                        if "legacy" = get parts 3 -> legacy: true
                    ]
                ][
                    if "legacy" = thirdPart -> legacy: true
                ]
            ]
            
            ; Special handling for web builds
            if os = "web" [
                arch: "js"
                mode: "mini"
            ]
            
            ; Build nested structure
            unless key? binaries os -> binaries\[os]: #[
                icon: translate os #[
                    Linux:     "M16 5C10.488 5 6 9.488 6 15v8c0 1.117-.883 2-2 2v2c2.2 0 4-1.8 4-4v-8c0-4.43 3.57-8 8-8a7.98 7.98 0 0 1 2.875.531c-.293.414-.137 1.145.406 1.688c.586.586 1.39.734 1.782.344c.144-.145.187-.368.187-.594A7.978 7.978 0 0 1 24 15v8c0 2.2 1.8 4 4 4v-2c-1.117 0-2-.883-2-2v-8c0-5.512-4.488-10-10-10zm-3 6c-1.52 0-2.668.852-3.25 1.875C9.168 13.898 9 15.047 9 16c0 1.355.414 2.348.875 2.969c.043.058.082.101.125.156c-.613.656-1 1.469-1 2.375c0 1.43.973 2.598 2.25 3.344C12.527 25.59 14.184 26 16 26c1.816 0 3.473-.41 4.75-1.156C22.027 24.098 23 22.93 23 21.5c0-.906-.387-1.719-1-2.375c.043-.055.082-.098.125-.156c.46-.621.875-1.614.875-2.969c0-.953-.168-2.102-.75-3.125A3.707 3.707 0 0 0 19 11a3.688 3.688 0 0 0-3 1.5a3.688 3.688 0 0 0-3-1.5zm0 2c.867 0 1.21.313 1.531.875c.32.563.469 1.418.469 2.125h2c0-.707.148-1.563.469-2.125c.32-.563.664-.875 1.531-.875c.867 0 1.21.313 1.531.875c.32.563.469 1.418.469 2.125c0 .96-.277 1.48-.5 1.781c-.07.098-.11.14-.156.188c-.227-.114-.446-.25-.688-.344c.211-.273.344-.672.344-1.125c0-.828-.45-1.5-1-1.5s-1 .672-1 1.5c0 .266.078.504.156.719A10.963 10.963 0 0 0 16 17c-.758 0-1.469.082-2.156.219c.078-.215.156-.453.156-.719c0-.828-.45-1.5-1-1.5s-1 .672-1 1.5c0 .453.133.852.344 1.125c-.242.094-.461.23-.688.344a1.334 1.334 0 0 1-.156-.188c-.223-.3-.5-.82-.5-1.781c0-.707.148-1.563.469-2.125c.32-.563.664-.875 1.531-.875zm3 6c1.5 0 2.855.352 3.75.875S21 20.996 21 21.5s-.355 1.102-1.25 1.625c-.895.523-2.25.875-3.75.875s-2.855-.352-3.75-.875S11 22.004 11 21.5s.355-1.102 1.25-1.625C13.145 19.352 14.5 19 16 19zm-2.5 1.438l-1 1.718S13.926 23 16 23s3.5-.844 3.5-.844l-1-1.718S17.547 21 16 21c-1.547 0-2.5-.563-2.5-.563z"
                    FreeBSD:   "M5 5v1c0 1.852.621 3.855 1.5 5.469A10.989 10.989 0 0 0 5 17c0 6.063 4.938 11 11 11c5.695 0 10.387-4.352 10.938-9.906c.035-.364.062-.723.062-1.094c0-1.574-.336-3.098-.969-4.5c-.05.086-.082.148-.125.219c-.343.765-.742 1.574-1.156 2.25A8.79 8.79 0 0 1 25 17c0 .305-.004.61-.031.906A8.998 8.998 0 0 1 16 26c-4.984 0-9-4.016-9-9s4.016-9 9-9c.43 0 .836.035 1.25.094c.242-.324.492-.614.719-.875v-.032L18.156 7c.219-.238.426-.441.625-.625A10.852 10.852 0 0 0 16 6c-1.395 0-2.738.273-3.969.75a8.273 8.273 0 0 0-1.094-.656C9.817 5.535 8.168 5 6 5zm21 0c-2.168 0-3.816.535-4.938 1.094c-1.12.558-1.78 1.187-1.78 1.187L19 7.594v.437s.023 1.211.656 2.438C20.29 11.695 21.72 13 24 13h.531l.313-.438S27 9.445 27 6V5zM7.219 7.156c1.093.14 2.031.39 2.687.688c-.746.496-1.398 1.09-2 1.75a13.263 13.263 0 0 1-.687-2.438zm17.5 0c-.328 1.758-.91 3.137-1.25 3.719c-1.098-.168-1.696-.688-2.032-1.344c-.28-.543-.277-.808-.312-1.094c.172-.144.23-.238.813-.53c.644-.321 1.636-.598 2.78-.75z"
                    macOS:     "M20.844 2c-1.64 0-3.297.852-4.407 2.156v.032c-.789.98-1.644 2.527-1.375 4.312c-.128-.05-.136-.035-.28-.094c-.692-.281-1.548-.594-2.563-.594c-3.98 0-7 3.606-7 8.344c0 3.067 1.031 5.942 2.406 8.094c.688 1.078 1.469 1.965 2.281 2.625c.813.66 1.664 1.125 2.625 1.125c.961 0 1.68-.324 2.219-.563c.54-.238.957-.437 1.75-.437c.715 0 1.078.195 1.625.438c.547.242 1.293.562 2.281.562c1.07 0 1.98-.523 2.719-1.188c.738-.664 1.36-1.519 1.875-2.343c.516-.824.922-1.633 1.219-2.282c.148-.324.258-.593.343-.812c.086-.219.13-.281.188-.531l.188-.813l-.75-.343a5.33 5.33 0 0 1-1.5-1.063c-.625-.637-1.157-1.508-1.157-2.844A4.08 4.08 0 0 1 24.563 13c.265-.309.542-.563.75-.719c.105-.078.187-.117.25-.156c.062-.04.05-.027.156-.094l.843-.531l-.562-.844c-1.633-2.511-4.246-2.844-5.281-2.844c-.48 0-.82.168-1.25.25c.242-.226.554-.367.75-.624c.004-.004-.004-.028 0-.032c.011-.011.023-.02.031-.031h.031a6.16 6.16 0 0 0 1.563-4.438L21.78 2zm-1.188 2.313c-.172.66-.453 1.289-.906 1.78l-.063.063c-.382.516-.972.899-1.562 1.125c.164-.652.45-1.312.844-1.812c.008-.012.023-.02.031-.032c.438-.5 1.043-.875 1.656-1.125zm-7.437 5.5c.558 0 1.172.21 1.812.468c.64.258 1.239.594 2.094.594c.852 0 1.496-.336 2.25-.594c.754-.258 1.559-.469 2.344-.469c.523 0 1.816.333 2.906 1.344c-.191.172-.36.297-.563.531a6.21 6.21 0 0 0-1.53 4.094c0 1.906.831 3.34 1.718 4.25c.55.563.89.696 1.313.938c-.055.125-.086.222-.157.375a18.82 18.82 0 0 1-1.093 2.062c-.454.727-1.004 1.434-1.532 1.907c-.527.472-1 .687-1.375.687c-.566 0-.898-.156-1.468-.406S17.581 25 16.5 25c-1.137 0-1.977.336-2.563.594c-.585.258-.89.406-1.406.406c-.246 0-.777-.2-1.375-.688c-.597-.488-1.254-1.23-1.844-2.156c-1.183-1.851-2.093-4.394-2.093-7c0-3.941 2.199-6.343 5-6.343z"
                    Windows:   "M27 5L5 7.992v16.016L27 27V5zm-2 2.29V15H15V8.65l10-1.36zM13 8.921V15H7V9.738l6-.816zM7 17h6v6.078l-6-.816V17zm8 0h10v7.71l-10-1.36V17z"
                    Web:       "M5 5v22h22V5H5zm2 2h18v18H7V7zm13.244 8c-1.425 0-2.346.912-2.346 2.12c0 1.31.77 1.937 1.928 2.43l.4.173c.733.323 1.169.511 1.169 1.062c0 .465-.427.799-1.092.799c-.788 0-1.236-.418-1.578-.979l-1.31.75c.464.931 1.433 1.645 2.925 1.645c1.52 0 2.66-.788 2.66-2.232c0-1.35-.77-1.949-2.139-2.528l-.398-.172c-.693-.304-.988-.503-.988-.978c0-.39.294-.694.77-.694c.465 0 .758.2 1.034.694l1.256-.807c-.532-.93-1.265-1.283-2.29-1.283zm-5.85.096v5.463c0 .798-.342 1.005-.865 1.005c-.55 0-.788-.379-1.035-.826l-1.31.79c.38.807 1.129 1.472 2.412 1.472C15.02 23 16 22.24 16 20.576v-5.48h-1.605z"
                ]
                arch: #[]
            ]
            unless key? binaries\[os] 'arch [
                binaries\[os]\arch: #[]
            ]

            unless key? binaries\[os]\arch arch [
                binaries\[os]\arch\[arch]: #[]
            ]
            
            ; Create entry
            entry: #[
                path: ~"files/|artifactName|.zip"
                size: fileSize
                checksum: checksum
            ]
            
            ; ; Add to structure (handle legacy properly)
            ; switch legacy [
            ;     print ["Adding legacy build for" os arch mode]
            ;     ; For legacy, we need mode entry first
            ;     unless key? binaries\[os]\[arch] mode [
            ;         binaries\[os]\[arch]\[mode]: #[]
            ;     ]
            ;     binaries\[os]\[arch]\[mode]\legacy: entry
            ; ][
            ;     print ["Adding build for" os arch mode]
            ;     binaries\[os]\[arch]\[mode]: entry
            ; ]
            unless legacy [
                binaries\[os]\arch\[arch]\[mode]: entry
            ]
            
            print ["Added:" ~"|artifactName|.zip" ~"(|fileSize|)"]
        ]
    ]
]

; Sort the structure by platform order
sortedBinaries: #.raw flatten arrange binaries [pfm,v][ index values platforms pfm] ;#[]
; loop sort keys platformOrder 'platform [
;     print ["Sorting platform:" platform]
;     if key? binaries platform [
;         print ["Adding platform to sorted list:" platform]
;         sortedBinaries\[platform]: binaries\[platform]
;     ]
; ]

; Get version and build date from environment
version: arg\0
versionAlias: arg\1
buildDate: strip execute ~"date -u '+%Y-%m-%d %H:%M:%S UTC'"

; Generate the _index.art file
output: {;
;  Arturo Website Data       
;  Auto-generated by CI      
;

;================================
; Binary Downloads
;================================

binaries: } ++ (express.pretty sortedBinaries) ++ {

version: "} ++ version ++ {"
buildDate: "} ++ buildDate ++ {"
}

; Write to file
write output "docs/website/pages/_index.art" 

newGettingStarted: replace read "docs/website/pages/documentation/getting started.art" "content: {!md" output ++ "\ncontent: {!md"
write newGettingStarted "docs/website/pages/documentation/getting started.art"

inspect sort # to :block output

print "\nGenerated _index.art:"
print read "docs/website/pages/_index.art"


[versionPart,buildPart]: split.by:"+" to :string sys\version

Details: #[
    version: versionPart
    build: 0
    arch: ~"|sys\cpu\arch|/|sys\os|"
    branch: versionAlias
]

if or? [contains? buildPart "."][3 < to :integer buildPart][
    Details\build: ~"|buildPart| @ |sys\built|"
]

write express Details "details.art"