name: Test MacPorts builds

on:
  pull_request:
  workflow_dispatch:
    
concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    macos-macports:
        runs-on: macos-26
        
        steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        
        - name: Uninstall Homebrew completely
          run: |
            # Run the official Homebrew uninstall script
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
            
            # Remove the paths.d file that failed to delete
            sudo rm -f /etc/paths.d/homebrew
            
            # Remove all remaining Homebrew directories (Apple Silicon location)
            sudo rm -rf /opt/homebrew
            
            # Remove Intel Mac locations (just in case)
            sudo rm -rf /usr/local/Homebrew
            sudo rm -rf /usr/local/Caskroom
            sudo rm -rf /usr/local/Cellar
            sudo rm -rf /usr/local/bin/brew
            
            # Clean up user caches
            rm -rf ~/Library/Caches/Homebrew
            rm -rf ~/Library/Logs/Homebrew
            
            # Verify removal
            echo "Homebrew removed. Checking for any remaining brew command..."
            which brew && echo "WARNING: brew still found in PATH" || echo "brew successfully removed"
        
        - name: Install MacPorts
          run: |
            curl -LO https://github.com/macports/macports-base/releases/download/v2.11.6/MacPorts-2.11.6-26-Tahoe.pkg
            sudo installer -pkg MacPorts-2.11.6-26-Tahoe.pkg -target /
        
        - name: Install GMP and libiconv via MacPorts
          run: |
            export PATH=/opt/local/bin:/opt/local/sbin:$PATH
            sudo port selfupdate
            sudo port install gmp libiconv
        
        - name: Install Nim and patch encodings
          run: |
            export PATH=/opt/local/bin:/opt/local/sbin:$PATH
            sudo port install nim
            
            # Patch Nim's encodings.nim to use system iconv (avoids MacPorts conflict)
            NIM_LIB=$(nim dump 2>&1 | grep "/lib/pure$" | head -1 | sed 's|/pure$||')
            
            if [ -z "$NIM_LIB" ]; then
                echo "⚠ Could not find Nim lib directory"
                exit 1
            fi
            
            echo "Found Nim lib at: $NIM_LIB"
            
            if [ -f "$NIM_LIB/pure/encodings.nim" ]; then
                sed -i.bak 's|const iconvDll = "libiconv.dylib"|const iconvDll = "/usr/lib/libiconv.dylib"|g' "$NIM_LIB/pure/encodings.nim"
                echo "✓ Patched encodings.nim for macOS system iconv compatibility"
                grep "iconvDll" "$NIM_LIB/pure/encodings.nim" | grep -v "^#"
            else
                echo "⚠ encodings.nim not found at $NIM_LIB/pure/encodings.nim"
                exit 1
            fi
        
        - name: Build Arturo from source
          run: |
            export PATH=/opt/local/bin:/opt/local/sbin:$PATH
            cd $GITHUB_WORKSPACE
            ./build.nims --install
        
        - name: Test Arturo
          run: |
            export PATH=$HOME/.arturo/bin:$PATH
            arturo -v
            arturo -c 'print "Hello from MacPorts Arturo!"'