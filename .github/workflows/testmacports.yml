name: Test MacPorts builds

on:
  pull_request:
  workflow_dispatch:
    
concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    macos-macports:
        runs-on: macos-26
        
        steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Install Nim
          run: |
            brew install nim 

        - name: Build Arturo from source
          run: |
            export PATH=/opt/local/bin:/opt/local/sbin:$PATH
            cd $GITHUB_WORKSPACE
            ./build.nims --install --log
        
        - name: Uninstall Homebrew completely
          run: |
            # Run the official Homebrew uninstall script
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
            
            # Remove the paths.d file that failed to delete
            sudo rm -f /etc/paths.d/homebrew
            
            # Remove all remaining Homebrew directories (Apple Silicon location)
            sudo rm -rf /opt/homebrew
            
            # Remove Intel Mac locations (just in case)
            sudo rm -rf /usr/local/Homebrew
            sudo rm -rf /usr/local/Caskroom
            sudo rm -rf /usr/local/Cellar
            sudo rm -rf /usr/local/bin/brew
            
            # Clean up user caches
            rm -rf ~/Library/Caches/Homebrew
            rm -rf ~/Library/Logs/Homebrew
            
            # Verify removal
            echo "Homebrew removed. Checking for any remaining brew command..."
            which brew && echo "WARNING: brew still found in PATH" || echo "brew successfully removed"
        
        - name: Install MacPorts
          run: |
            curl -LO https://github.com/macports/macports-base/releases/download/v2.11.6/MacPorts-2.11.6-26-Tahoe.pkg
            sudo installer -pkg MacPorts-2.11.6-26-Tahoe.pkg -target /
        
        - name: Install GMP and libiconv via MacPorts
          run: |
            export PATH=/opt/local/bin:/opt/local/sbin:$PATH
            sudo port selfupdate
            sudo port install gmp mpfr libiconv
        
        - name: Test Arturo
          run: |
            export PATH=$HOME/.arturo/bin:$PATH
            arturo -v
            arturo -e 'print "Hello from MacPorts Arturo!"' 