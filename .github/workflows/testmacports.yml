name: Test MacPorts GMP/MPFR

on:
  pull_request:
  workflow_dispatch:

concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
  test-macports:
    runs-on: macos-26
    
    steps:
      - name: Checkout Arturo repo
        uses: actions/checkout@v4
        with:
            repository: arturo-lang/arturo
            submodules: recursive
            ref: ${{ github.ref }}
      
      - name: Check initial Homebrew GMP/MPFR installation
        run: |
          echo "=== Checking Homebrew installations ==="
          brew list gmp || echo "GMP not installed via Homebrew"
          brew list mpfr || echo "MPFR not installed via Homebrew"
          
      - name: Install Nim via Homebrew
        run: |
          echo "=== Installing Nim ==="
          brew install nim
          
      - name: Build Arturo with Homebrew GMP/MPFR
        run: |
          echo "=== Building Arturo with Homebrew libraries ==="
          ./build.nims --install --log          

          echo "$HOME/.arturo/bin" >> $GITHUB_PATH
          ls -la bin
        shell: bash
        
      - name: Test Arturo with Homebrew libraries
        run: |
          echo "=== Testing with Homebrew GMP/MPFR ==="
          bin/arturo -v
          bin/arturo -e "inspect sys"
          bin/arturo -e "print 2 ^ 100"
          
      - name: Uninstall Homebrew GMP/MPFR
        run: |
          echo "=== Uninstalling Homebrew GMP/MPFR ==="
          brew uninstall --ignore-dependencies gmp mpfr
          
      - name: Verify Homebrew uninstallation
        run: |
          echo "=== Verifying Homebrew uninstallation ==="
          if brew list gmp 2>/dev/null; then
            echo "ERROR: GMP still installed via Homebrew"
            exit 1
          else
            echo "✓ GMP successfully uninstalled from Homebrew"
          fi
          
          if brew list mpfr 2>/dev/null; then
            echo "ERROR: MPFR still installed via Homebrew"
            exit 1
          else
            echo "✓ MPFR successfully uninstalled from Homebrew"
          fi
          
      - name: Install MacPorts for Tahoe
        run: |
          echo "=== Installing MacPorts for macOS Tahoe ==="
          curl -LO https://github.com/macports/macports-base/releases/download/v2.11.6/MacPorts-2.11.6-26-Tahoe.pkg
          sudo installer -pkg MacPorts-2.11.6-26-Tahoe.pkg -target /
          
      - name: Verify MacPorts installation
        run: |
          export PATH=/opt/local/bin:/opt/local/sbin:$PATH
          which port
          port version
          
      - name: Install GMP and MPFR via MacPorts
        run: |
          export PATH=/opt/local/bin:/opt/local/sbin:$PATH
          sudo port selfupdate
          sudo port install gmp mpfr libiconv
          
      - name: Verify MacPorts GMP/MPFR installation
        run: |
          echo "=== Verifying MacPorts installations ==="
          ls -la /opt/local/lib/libgmp* || echo "GMP not found"
          ls -la /opt/local/lib/libmpfr* || echo "MPFR not found"
          ls -la /opt/local/include/gmp.h || echo "GMP header not found"
          ls -la /opt/local/include/mpfr.h || echo "MPFR header not found"
          
      - name: Test Arturo with MacPorts libraries
        run: |
          echo "=== Testing Arturo binary (built with Homebrew) on MacPorts libraries ==="
          bin/arturo -v
          bin/arturo -e "inspect sys"
          bin/arturo -e "print 2 ^ 100"