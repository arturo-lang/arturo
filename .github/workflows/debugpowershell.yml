name: Test execCmdEx

on:
  pull_request:

concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
  test-nim-exec:
    strategy:
      matrix:
        os: 
          - windows-latest
          - windows-2022
          - windows-2019
        
        shell_type: [bash, powershell]
      
      fail-fast: false
    
    runs-on: ${{ matrix.os }}
    
    defaults:
      run:
        shell: ${{ matrix.shell_type }}
    
    steps:
      
      - name: Setup Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: 'stable'
      
      - name: Create test file
        shell: bash
        run: |
          cat > test.nim << 'EOF'
          import osproc
          echo execCmdEx "echo 'Hi!'"
          EOF
      
      - name: Test 1 - Simple command without poEvalCommand
        run: |
            cat > test1.nim << 'EOF'
            import osproc
            echo "Test 1:"
            echo execCmdEx("dir", options = {poUsePath})
            EOF
            nim r test1.nim

      - name: Test 2 - Check which shell is used
        run: |
            cat > test2.nim << 'EOF'
            import osproc
            echo "Test 2:"
            echo execCmdEx("echo %COMSPEC%", options = {poEvalCommand, poUsePath})
            EOF
            nim r test2.nim

      - name: Test 3 - Explicit cmd.exe
        run: |
            cat > test3.nim << 'EOF'
            import osproc
            echo "Test 3:"
            echo execCmdEx("cmd.exe /c echo Hi", options = {poUsePath})
            EOF
            nim r test3.nim

      - name: Test 4 - Async with timeout
        run: |
            cat > test4.nim << 'EOF'
            import osproc, os
            echo "Test 4:"
            let p = startProcess("cmd.exe", args = ["/c", "echo Hi"], options = {poUsePath, poStdErrToStdOut})
            sleep(1000)
            if running(p):
                echo "Still running - HANG DETECTED"
                terminate(p)
            else:
                echo "Output: ", outputStream(p).readAll()
                echo "Exit: ", waitForExit(p)
            close(p)
            EOF
            nim r test4.nim

      - name: Test 5 - Original failing case
        run: |
            cat > test5.nim << 'EOF'
            import osproc
            echo "Test 5:"
            echo execCmdEx("echo 'Hi!'")
            EOF
            nim r test5.nim
      
      - name: Show Windows version
        shell: powershell
        run: Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, OsArchitecture