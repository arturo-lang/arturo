name: Release
 
on:
    push:
        tags:
            - 'v*.*.*'
    
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to release (e.g., 0.10.0)'
                required: true
                type: string

concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    Validate:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.extract.outputs.version }}
            tag_name: ${{ steps.extract.outputs.tag_name }}
        steps:
            - uses: actions/checkout@v4
              with:
                ref: ${{ github.ref }}
            
            - name: Extract and validate version
              id: extract
              run: |
                # Extract version from tag or workflow input
                if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                    TAG_NAME="v${VERSION}"
                else
                    TAG_NAME="${GITHUB_REF#refs/tags/}"
                    VERSION="${TAG_NAME#v}"
                fi
                
                echo "version=$VERSION" >> $GITHUB_OUTPUT
                echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
                
                # Read version files
                FILE_VERSION=$(cat version/version | tr -d '\n\r')
                FILE_REVISION=$(cat version/revision | tr -d '\n\r')
                FILE_METADATA=$(cat version/metadata | tr -d '\n\r')
                FILE_CODENAME=$(cat version/codename | tr -d '\n\r')
                    
                echo "=========================================="
                echo "Release Validation"
                echo "=========================================="
                echo "Tag version:     $VERSION"
                echo "File version:    $FILE_VERSION"
                echo "Revision:        $FILE_REVISION"
                echo "Metadata:        $FILE_METADATA"
                echo "Codename:        $FILE_CODENAME"
                echo "=========================================="
                
                # Validate version matches
                if [ "$VERSION" != "$FILE_VERSION" ]; then
                    echo "âŒ ERROR: Tag version ($VERSION) doesn't match version/version ($FILE_VERSION)"
                    exit 1
                fi
                
                # Validate revision is 0
                if [ "$FILE_REVISION" != "0" ]; then
                    echo "âŒ ERROR: Revision must be 0 for releases (found: $FILE_REVISION)"
                    exit 1
                fi
                
                # Validate metadata is empty
                if [ -n "$FILE_METADATA" ]; then
                    echo "âŒ ERROR: Metadata must be empty for releases (found: $FILE_METADATA)"
                    exit 1
                fi
                
                # Validate codename exists
                if [ -z "$FILE_CODENAME" ]; then
                    echo "âŒ ERROR: Codename must be set for releases"
                    exit 1
                fi
                
                # Validate version doesn't contain -dev
                if [[ "$FILE_VERSION" == *"-dev"* ]]; then
                    echo "âŒ ERROR: Version cannot contain '-dev' for releases"
                    exit 1
                fi
                
                echo "âœ… All validations passed!"
                echo "ðŸ“¦ Ready to release: Arturo $VERSION \"$FILE_CODENAME\""

    Build:
        needs: Validate
        runs-on: ${{ 
            (matrix.os == 'linux')   && (matrix.support == 'legacy' && (matrix.arch == 'arm64' && 'ubuntu-22.04-arm' || 'ubuntu-22.04') || matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest') ||
            (matrix.os == 'macos')   && (matrix.arch == 'arm64' && 'macos-latest' || 'macOS-15-intel') ||
            (matrix.os == 'windows') && 'windows-latest' || 
                                        'ubuntu-latest'  }}
                                                                   
        strategy:
            matrix:
                include: 
                    # - {os: linux,   arch: amd64}
                    # - {os: linux,   arch: amd64,    support: legacy}
                    # - {os: linux,   arch: amd64,    mode: mini}
                    # - {os: linux,   arch: arm64}
                    # - {os: linux,   arch: arm64,    support: legacy}
                    # - {os: linux,   arch: arm64,    mode: mini}
                    # - {os: freebsd, arch: amd64}
                    # - {os: freebsd, arch: amd64,    mode: mini}
                    # - {os: macos,   arch: amd64}
                    # - {os: macos,   arch: amd64,    mode: mini}
                    # - {os: macos,   arch: arm64}
                    # - {os: macos,   arch: arm64,    mode: mini}
                    # - {os: windows, arch: amd64}
                    # - {os: windows, arch: amd64,    mode: mini}
                    - {os: web,     arch: js,       mode: mini}
 
        defaults:
            run:
                shell: ${{ 
                    (matrix.os == 'freebsd') && 'freebsd {0}' ||
                    (matrix.os == 'windows') && 'msys2 {0}'   || 
                                                'bash'        }}

        steps:
            - name: Build Arturo
              uses: arturo-lang/arturo-action@v2
              with: 
                do: compile
                token: ${{ secrets.GITHUB_TOKEN }}
                os: ${{ matrix.os }}
                arch: ${{ matrix.arch }}
                mode: ${{ matrix.mode }}
                support: ${{ matrix.support }}
                create_artifact: 'true'
                artifact_version: ${{ needs.Validate.outputs.version }}

    Release:
        runs-on: ubuntu-latest
        needs: 
            - Validate
            - Build
        steps:
            - uses: actions/checkout@v4
              with:
                ref: ${{ needs.Validate.outputs.tag_name }}
            
            - name: Download artifacts
              uses: dawidd6/action-download-artifact@v11
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                run_id: ${{ github.run_id }}
                path: ./assets
                skip_unpack: true

            - name: Debug environment
              run: |
                echo "Version: ${{ needs.Validate.outputs.version }}"
                echo "Tag: ${{ needs.Validate.outputs.tag_name }}"
                echo "Codename: $(cat version/codename)"
                echo "Assets:"
                ls -laR ./assets

            - name: Create release
              run: |
                CODENAME=$(cat version/codename)
                COMMIT_SHA=$(git rev-parse HEAD)
                COMMIT_SHORT=$(git rev-parse --short HEAD)
                
                # Find previous release tag
                PREV_TAG=$(git tag --sort=-version:refname | grep "^v[0-9]*\.[0-9]*\.[0-9]*$" | sed -n '2p')
                CURR_TAG="${{ needs.Validate.outputs.tag_name }}"
                
                echo "Generating release notes from $PREV_TAG to $CURR_TAG"
                
                # Get all PR numbers
                PR_NUMS=$(git log ${PREV_TAG}..${CURR_TAG} --merges --pretty=format:"%s" | \
                  grep "^Merge pull request #" | \
                  sed -E 's/Merge pull request #([0-9]+) from .*/\1/' | tr '\n' ',')
                
                # Fetch all PRs
                DATA=$(gh api graphql -f query="
                {
                  repository(owner: \"arturo-lang\", name: \"arturo\") {
                    $(echo $PR_NUMS | tr ',' '\n' | while read num; do
                      [ -n "$num" ] && echo "pr$num: pullRequest(number: $num) { title labels(first: 10) { nodes { name } } }"
                    done)
                  }
                }" 2>/dev/null)
                
                # Parse and categorize
                CHANGELOG=$(echo "$DATA" | jq -r '
                  .data.repository | to_entries[] | 
                  select(.value.labels.nodes | map(.name) | 
                    (contains(["new feature"]) or contains(["enhancement"]) or contains(["bug"]))) |
                  {
                    title: .value.title,
                    num: (.key | ltrimstr("pr")),
                    labels: [.value.labels.nodes[].name]
                  } |
                  if (.labels | contains(["new feature"])) then "FEATURE|- \(.title) (#\(.num))"
                  elif (.labels | contains(["bug"])) then "BUG|- \(.title) (#\(.num))"
                  elif (.labels | contains(["enhancement"])) then "ENHANCE|- \(.title) (#\(.num))"
                  else empty end
                ' | awk -F'|' '
                  /^FEATURE/ { features = features $2 "\n" }
                  /^BUG/ { bugs = bugs $2 "\n" }
                  /^ENHANCE/ { enhancements = enhancements $2 "\n" }
                  END {
                    if (features) printf "## ðŸŽ‰ New Features\n\n%s\n", features
                    if (bugs) printf "## ðŸ› Bug Fixes\n\n%s\n", bugs
                    if (enhancements) printf "## ðŸš€ Enhancements\n\n%s\n", enhancements
                  }
                ')
                
                cat > release-notes.md << EOF
                **Arturo ${{ needs.Validate.outputs.version }} "${CODENAME}"**
                
                Official release of Arturo ${{ needs.Validate.outputs.version }}.
                
                **Commit:** [\`${COMMIT_SHORT}\`](https://github.com/arturo-lang/arturo/commit/${COMMIT_SHA})
                
                ---
                
                ${CHANGELOG}
                
                **Full Changelog**: https://github.com/arturo-lang/arturo/compare/${PREV_TAG}...v${{ needs.Validate.outputs.version }}
                EOF
                
                gh release create "${{ needs.Validate.outputs.tag_name }}" \
                  --title "Arturo ${{ needs.Validate.outputs.version }} \"${CODENAME}\"" \
                  --notes-file release-notes.md \
                  ./assets/*
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    Deploy:
        uses: arturo-lang/website/.github/workflows/deploy.yml@main
        needs: Release
        secrets: inherit
        with:
            channel: 'stable'