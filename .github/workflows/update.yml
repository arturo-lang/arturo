name: Update

on:
    push:
        branches:
            - 'master'
        tags-ignore:
            - '**'
    pull_request:
        paths-ignore:
            - 'docs/*'
            - '*.yml'
            - '*.md'
            - 'LICENSE'
      
concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Step 1: Auto-increment build number
    Build:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        outputs:
            version_tag: ${{ steps.version-info.outputs.VERSION_TAG }}
            
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                ref: master
                fetch-depth: 0
                token: ${{ secrets.PAT_TOKEN }}
      
            - name: Increment build number and get version info
              id: version-info
              run: |
                version_tag="TEST"
                echo "VERSION_TAG=${version_tag}" >> "$GITHUB_OUTPUT"
            
            # - name: Configure Git
            #   run: |
            #     git config user.name "GitHub Actions Bot"
            #     git config user.email "actions@github.com"
      
            # - name: Increment build number and get version info
            #   id: version-info
            #   run: |
            #     # Read current build number
            #     current_build=$(cat version/build)
                
            #     # Increment it
            #     new_build=$((current_build + 1))
                
            #     # Update file
            #     echo $new_build > version/build
                
            #     # Read version
            #     if [ -f "version/version" ]; then
            #         version=$(cat version/version)
            #     else
            #         version=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.9.83")
            #     fi
                
            #     # Create version tag (format: master.abc1234)
            #     git_hash=$(git rev-parse --short HEAD)
            #     version_tag="master.${git_hash}"
            #     echo "VERSION_TAG=${version_tag}" >> "$GITHUB_OUTPUT"
                
            #     echo "New build number: $new_build"
            #     echo "Version tag: $version_tag"
                
            #     # Commit and push
            #     git add version/build
            #     git commit -m "Update build to ${new_build}"
            #     git push origin master

    # Step 2: Build all binaries with new version
    Binaries:
        runs-on: ${{ 
            (matrix.os == 'linux')   && (matrix.support == 'legacy' && (matrix.arch == 'arm64' && 'ubuntu-22.04-arm' || 'ubuntu-22.04') || matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest') ||
            (matrix.os == 'macos')   && (matrix.arch == 'arm64' && 'macos-latest' || 'macOS-15-intel') ||
            (matrix.os == 'windows') && 'windows-latest' || 
                                        'ubuntu-latest'  }}
        needs: Build
        strategy:
            matrix:
                include: 
                    - {os: linux,   arch: amd64, mode: full}
                    - {os: linux,   arch: amd64, mode: full, support: legacy}
                    - {os: linux,   arch: amd64, mode: safe}
                    - {os: linux,   arch: amd64, mode: mini}
                    - {os: linux,   arch: arm64, mode: full}
                    - {os: linux,   arch: arm64, mode: full, support: legacy}
                    - {os: linux,   arch: arm64, mode: mini}
                    - {os: freebsd, arch: amd64, mode: full}
                    - {os: freebsd, arch: amd64, mode: mini}
                    - {os: macos,   arch: amd64, mode: full}
                    - {os: macos,   arch: amd64, mode: mini}
                    - {os: macos,   arch: arm64, mode: full}
                    - {os: macos,   arch: arm64, mode: mini}
                    - {os: windows, arch: amd64, mode: full}
                    - {os: windows, arch: amd64, mode: mini}
                    - {os: web}

        name: Build ${{ matrix.os }}-${{ matrix.arch || 'js' }}-${{ matrix.mode || 'mini' }}${{ matrix.support == 'legacy' && '-legacy' || '' }}
        defaults:
            run:
                shell: ${{ 
                    (matrix.os == 'freebsd') && 'freebsd {0}' ||
                    (matrix.os == 'windows') && 'msys2 {0}'   || 
                                                'bash'        }}
        steps:
            - name: Install Arturo
              uses: arturo-lang/arturo-action@v2
              with: 
                do: compile
                token: ${{ secrets.GITHUB_TOKEN }}
                os: ${{ matrix.os }}
                arch: ${{ matrix.arch }}
                mode: ${{ matrix.mode }}
                support: ${{ matrix.support }}
                src: master
                metadata: ${{ needs.Build.outputs.version_tag }}
                create_artifact: 'true'
                artifact_version: ${{ needs.Build.outputs.version_tag }}

    # Step 3: Generate documentation and combine with binaries
    Documentation:
        runs-on: ubuntu-latest
        name: Generate Documentation & Deploy
        needs: [Build, Binaries]
        defaults:
            run:
                shell: bash
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                fetch-depth: 0

            - name: Install Arturo
              uses: arturo-lang/arturo-action@v2
              with: 
                do: compile
                mode: docgen
                token: ${{ secrets.GITHUB_TOKEN }}
                metadata: ${{ needs.Build.outputs.version_tag }}

            - name: "Install Node"
              uses: actions/setup-node@v4
              with:
                node-version: latest

            - name: "Install build dependencies"
              run: |
                sudo apt-get update
                sudo apt-get install -y build-essential libcmocka-dev

            - name: "Install Ruby"
              uses: ruby/setup-ruby@v1
              with:
                ruby-version: 3.3
                bundler-cache: true
        
            - name: "Install gems"
              run: |
                gem install commonmarker -v "2.1.0" --platform=ruby

            - name: "Install prerequisites"
              run: |
                sudo apt-get update
                sudo apt-get install webp 
                sudo npm install -g sass uglify-js

            - name: Download all binary artifacts
              uses: actions/download-artifact@v4
              with:
                path: binaries/
                pattern: arturo-*

            - name: Prepare website data from binaries
              run: |
                # Initialize _index.art file with proper structure
                cat > docs/website/pages/_index.art << 'EOF'
                ;
                ;  Arturo Website Data       
                ;  Auto-generated by CI      
                ;
                
                ;================================
                ; Binary Downloads
                ;================================
                
                binaries: #[
                EOF
                
                # Define platform order
                declare -A platform_order=(
                  ["linux"]=1
                  ["macos"]=2
                  ["windows"]=3
                  ["freebsd"]=4
                  ["web"]=5
                )
                
                # Track platforms and their architectures
                declare -A platforms
                
                # First pass: collect all binaries organized by platform/arch/mode/legacy
                for binary_dir in binaries/arturo-*/; do
                  if [ -d "$binary_dir" ]; then
                    artifact_name=$(basename "$binary_dir")
                    echo "Processing: $artifact_name"
                    
                    # Find the binary file (for size/checksum calculation)
                    binary_file=$(find "$binary_dir" -type f \( -name "arturo" -o -name "arturo.exe" -o -name "arturo.js" \) | head -1)
                    
                    if [ -n "$binary_file" ]; then
                      # We'll create a zip of the entire artifact directory
                      zip_name="${artifact_name}.zip"
                      
                      # Create zip from the artifact directory contents
                      (cd "$binary_dir" && zip -r "../../${zip_name}" .)
                      
                      # Get size and checksum of the zip file
                      file_size=$(ls -lh "${zip_name}" | awk '{print $5}')
                      sha256_hash=$(sha256sum "${zip_name}" | awk '{print $1}')
                      
                      # Parse artifact name: arturo-VERSION-OS-ARCH[-MODE][-legacy]
                      remainder="${artifact_name#arturo-*-}"
                      
                      # Parse components
                      os=$(echo "$remainder" | cut -d'-' -f1)
                      arch=$(echo "$remainder" | cut -d'-' -f2)
                      
                      # Initialize mode and legacy
                      mode="full"
                      legacy=""
                      
                      # Check for additional parts (mode/legacy)
                      parts_count=$(echo "$remainder" | awk -F'-' '{print NF}')
                      if [ $parts_count -ge 3 ]; then
                        third_part=$(echo "$remainder" | cut -d'-' -f3)
                        
                        case "$third_part" in
                          mini|safe)
                            mode="$third_part"
                            if [ $parts_count -ge 4 ]; then
                              fourth_part=$(echo "$remainder" | cut -d'-' -f4)
                              [ "$fourth_part" = "legacy" ] && legacy="legacy"
                            fi
                            ;;
                          legacy)
                            legacy="legacy"
                            ;;
                        esac
                      fi
                      
                      # Special handling for web builds
                      if [ "$os" = "web" ]; then
                        arch="js"
                        mode="mini"
                      fi
                      
                      # Store in associative array: platforms[os|arch|mode|legacy]=zip_name|size|checksum
                      key="${os}|${arch}|${mode}|${legacy}"
                      platforms[$key]="${zip_name}|${file_size}|${sha256_hash}"
                      
                      echo "Created: $zip_name ($file_size)"
                    fi
                  fi
                done
                
                # Second pass: output in sorted order
                # Sort platforms by order, then by arch
                for os in linux macos windows freebsd web; do
                  platform_found=false
                  
                  # Check if this platform has any binaries
                  for key in "${!platforms[@]}"; do
                    IFS='|' read -r p_os p_arch p_mode p_legacy <<< "$key"
                    if [ "$p_os" = "$os" ]; then
                      platform_found=true
                      break
                    fi
                  done
                  
                  if [ "$platform_found" = true ]; then
                    echo "    ${os}: #[" >> docs/website/pages/_index.art
                    
                    # Process each architecture for this platform
                    for arch in amd64 arm64 js; do
                      arch_found=false
                      
                      # Check if this arch exists for this platform
                      for key in "${!platforms[@]}"; do
                        IFS='|' read -r p_os p_arch p_mode p_legacy <<< "$key"
                        if [ "$p_os" = "$os" ] && [ "$p_arch" = "$arch" ]; then
                          arch_found=true
                          break
                        fi
                      done
                      
                      if [ "$arch_found" = true ]; then
                        echo "        ${arch}: #[" >> docs/website/pages/_index.art
                        
                        # Process each mode for this arch
                        for mode in full safe mini; do
                          # Check regular build
                          key="${os}|${arch}|${mode}|"
                          if [ -n "${platforms[$key]}" ]; then
                            IFS='|' read -r zip_name file_size sha256_hash <<< "${platforms[$key]}"
                            echo "            ${mode}: #[" >> docs/website/pages/_index.art
                            echo "                path: \"binaries/${zip_name}\"" >> docs/website/pages/_index.art
                            echo "                size: \"${file_size}\"" >> docs/website/pages/_index.art
                            echo "                checksum: \"${sha256_hash}\"" >> docs/website/pages/_index.art
                            echo "            ]" >> docs/website/pages/_index.art
                          fi
                          
                          # Check legacy build
                          key="${os}|${arch}|${mode}|legacy"
                          if [ -n "${platforms[$key]}" ]; then
                            IFS='|' read -r zip_name file_size sha256_hash <<< "${platforms[$key]}"
                            echo "            ${mode}: #[" >> docs/website/pages/_index.art
                            echo "                legacy: #[" >> docs/website/pages/_index.art
                            echo "                    path: \"binaries/${zip_name}\"" >> docs/website/pages/_index.art
                            echo "                    size: \"${file_size}\"" >> docs/website/pages/_index.art
                            echo "                    checksum: \"${sha256_hash}\"" >> docs/website/pages/_index.art
                            echo "                ]" >> docs/website/pages/_index.art
                            echo "            ]" >> docs/website/pages/_index.art
                          fi
                        done
                        
                        echo "        ]" >> docs/website/pages/_index.art
                      fi
                    done
                    
                    echo "    ]" >> docs/website/pages/_index.art
                  fi
                done
                
                # Close binaries block and add metadata
                cat >> docs/website/pages/_index.art << EOF
                ]
                
                version: "${{ needs.Build.outputs.version_tag }}"
                buildDate: "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
                EOF
                
                echo "Generated _index.art:"
                cat docs/website/pages/_index.art

            - name: "Generate website"
              run: |
                arturo tools/sitegen.art
                arturo tools/indexgen.art
                echo "#[release?: false]" > docs/website/data/setup.art
                mkdir tmpdocs
                cd docs/website
                arturo ../../tools/miniwebize/webize.art --build --at: ../../tmpdocs
                cd ../..
                arturo tools/genaiguide.art
                mv tools/aiguide.md tmpdocs/llms.txt

            - name: Copy binaries to website
              run: |
                mkdir -p tmpdocs/binaries
                
                # Create checksums file
                echo "# Arturo Binaries - ${{ needs.Build.outputs.version_tag }}" > tmpdocs/binaries/checksums.txt
                echo "# Generated on $(date -u)" >> tmpdocs/binaries/checksums.txt
                echo "" >> tmpdocs/binaries/checksums.txt
                
                # Copy all zip files
                for zip_file in arturo-*.zip; do
                  if [ -f "$zip_file" ]; then
                    cp "$zip_file" "tmpdocs/binaries/"
                    
                    # Generate checksum
                    cd tmpdocs/binaries
                    file_size=$(ls -lh "$(basename "$zip_file")" | awk '{print $5}')
                    sha256_hash=$(sha256sum "$(basename "$zip_file")" | awk '{print $1}')
                    echo "$sha256_hash  $(basename "$zip_file")  ($file_size)" >> checksums.txt
                    cd ../..
                    
                    echo "Copied: $(basename "$zip_file") ($file_size)"
                  fi
                done
                
                # Create version file
                echo "${{ needs.Build.outputs.version_tag }}" > tmpdocs/binaries/VERSION
                
                echo "Checksums:"
                cat tmpdocs/binaries/checksums.txt

            - name: Synchronize to website
              uses: burnett01/rsync-deployments@7.0.2
              with:
                switches: -avzr --delete
                path: tmpdocs/
                remote_path: /var/www/arturo-lang.io/test
                remote_host: arturo-lang.io
                remote_user: root
                remote_key: ${{ secrets.ARTUROLANG }}

            - name: Upload complete website artifact
              uses: 'actions/upload-artifact@v4'
              with:
                name: website-with-binaries-${{ needs.Build.outputs.version_tag }}
                path: tmpdocs

            - name: Display completion summary
              run: |
                echo "ðŸŽ‰ Build & Documentation Complete!"
                echo "Version: ${{ needs.Build.outputs.version_tag }}"
                echo "Binaries built: $(ls binaries/ | wc -l)"
                echo "Website deployed to: https://arturo-lang.io/test"
                echo "Binaries available at: https://arturo-lang.io/test/binaries/"