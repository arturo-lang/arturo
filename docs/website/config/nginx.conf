# /usr/local/etc/nginx/nginx.conf

user www;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Installer subdomain
    # server {
    #     listen 80;
    #     server_name get.arturo-lang.io;
        
    #     root /usr/local/www/arturo/main/versions;
        
    #     # Stable installer (default)
    #     location = / {
    #         return 301 /stable/tools/installer.sh;
    #     }
        
    #     # Nightly installer
    #     location = /latest {
    #         return 301 /nightly/tools/installer.sh;
    #     }
        
    #     # Serve actual installer scripts
    #     location ~ ^/(stable|nightly)/tools/installer\.sh$ {
    #         default_type text/plain;
    #     }
    # }
    
    # Main site
    server {
        listen 80 default_server;
        server_name 188.245.97.105;
        # server_name arturo-lang.io;
        
        root /usr/local/www/arturo/main/versions;
        index index.html;
        
        # GitHub fallback for latest binaries
        location ~ ^/latest/files/.*\.zip$ {
            # Extract date and platform from the actual filename
            if ($uri ~ ^/latest/files/arturo-nightly\.([0-9]{8})-(.+)$) {
                set $date $1;
                set $platform $2;
            }
            
            add_header X-Served-By "GitHub-Proxy" always;
            
            # Try GitHub's latest release first
            proxy_pass https://github.com/arturo-lang/nightly/releases/latest/download/arturo-nightly.$date-$platform;
            proxy_intercept_errors on;
            proxy_next_upstream error timeout invalid_header http_404 http_500 http_502 http_503;
            
            # If GitHub fails, serve from local
            error_page 404 500 502 503 504 = @local_files;
        }
        
        # Local files fallback
        location @local_files {
            root /usr/local/www/arturo/main/versions;
            add_header X-Served-By "Local-Fallback" always;
            try_files /latest/files/arturo-nightly.$date-$platform =404;
        }
        
        # Redirect ALL version paths without trailing slash
        location ~ ^/(test|latest|stable|v[0-9.]+)$ {
            return 301 $scheme://$host$uri/;
        }
        
        # All version locations 
        location ~ ^/(latest|stable|v[0-9.]+)/ {
            error_page 404 /$1/error/404/index.html;
        }
        
        # Error page locations - prevent direct access
        location ~ ^/([^/]+)/error/404/index\.html$ {
            internal;
        }
        
        # PHP handlers
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
        
        # Playground snippet URLs for all versions: /version/playground/snippetId
        location ~ ^/([^/]+)/playground/([a-zA-Z0-9]+)$ {
            try_files /$1/playground/index.html =404;
        }
        
        # Image caching
        location ~* \.(jpg|jpeg|png|webp|gif|ico)$ {
            expires 30d;
        }
        
        # CSS/JS caching
        location ~* \.(css|js)$ {
            expires 7d;
        }
        
        # Default location handler (maps to /stable)
        location / {
            error_page 404 /stable/error/404/index.html;
            try_files $uri $uri/index.html /stable$uri /stable$uri/index.html =404;
        }
    }
}