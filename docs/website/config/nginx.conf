# /usr/local/etc/nginx/nginx.conf

user www;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Installer subdomain
    # server {
    #     listen 80;
    #     server_name get.arturo-lang.io;
        
    #     root /usr/local/www/arturo/main/versions;
        
    #     # Stable installer (default)
    #     location = / {
    #         return 301 /stable/tools/installer.sh;
    #     }
        
    #     # Nightly installer
    #     location = /latest {
    #         return 301 /nightly/tools/installer.sh;
    #     }
        
    #     # Serve actual installer scripts
    #     location ~ ^/(stable|nightly)/tools/installer\.sh$ {
    #         default_type text/plain;
    #     }
    # }
    
    # Main site
    server {
        listen 80 default_server;
        server_name 188.245.97.105;
        # server_name arturo-lang.io;
        
        root /usr/local/www/arturo/main/versions;
        index index.html;
        
        # PHP handlers for test version (with auth)
        location ~ ^/test/.*\.php$ {
            try_files $uri =404;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            
            auth_basic "Test Version - Restricted Access";
            auth_basic_user_file /usr/local/etc/nginx/.htpasswd;
        }
        
        # Test version with auth (covers everything including playground)
        location /test {
            auth_basic "Test Version - Restricted Access";
            auth_basic_user_file /usr/local/etc/nginx/.htpasswd;
            
            # Test version 404 page
            error_page 404 /test/error/404/index.html;
        }
        
        # Specific version locations (nightly, stable, etc.)
        location ~ ^/(nightly|stable|v[0-9.]+)/ {
            # Version-specific 404 pages
            error_page 404 /$1/error/404/index.html;
        }
        
        # Error page locations - prevent direct access
        location ~ ^/([^/]+)/error/404/index\.html$ {
            internal;
        }
        
        # PHP handlers for all other versions (no auth)
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
        
        # Playground snippet URLs for all versions: /version/playground/snippetId
        location ~ ^/([^/]+)/playground/([a-zA-Z0-9]+)$ {
            try_files /$1/playground/index.html =404;
        }
        
        # Image caching
        location ~* \.(jpg|jpeg|png|webp|gif|ico)$ {
            expires 30d;
        }
        
        # CSS/JS caching
        location ~* \.(css|js)$ {
            expires 7d;
        }
        
        # Default location handler (maps to /stable)
        location / {
            # Default version (stable) 404 page
            error_page 404 /stable/error/404/index.html;
            
            try_files $uri $uri/index.html /stable$uri /stable$uri/index.html =404;
        }
    }
}