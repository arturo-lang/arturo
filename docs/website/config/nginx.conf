# /usr/local/etc/nginx/nginx.conf

user www;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    keepalive_timeout 65;
    
    # DNS resolver for proxying to external domains
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    ######################################
    ## Main site
    ######################################
    
    server {
        listen 80 default_server;
        server_name 188.245.97.105;
        # server_name arturo-lang.io;
        
        root /usr/local/www/arturo/main/versions;
        index index.html;
        
        ######################################
        ## GitHub proxy for /latest/ binaries
        ######################################
        
        location ~ ^/latest/files/(.+\.zip)$ {
            set $filename $1;
            
            # GitHub sends large headers
            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
            
            proxy_pass https://github.com/arturo-lang/nightly/releases/latest/download/$filename;
            proxy_intercept_errors on;
            error_page 301 302 307 = @handle_github_redirect;
        }
        
        location @handle_github_redirect {
            set $saved_redirect_location '$upstream_http_location';
            resolver 8.8.8.8 8.8.4.4;
            
            proxy_buffer_size 16k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 32k;
            
            proxy_pass $saved_redirect_location;
            proxy_intercept_errors on;
            error_page 404 500 502 503 504 = @serve_local;
        }
        
        location @serve_local {
            if ($uri ~ ^/latest/files/(.+)$) {
                set $filename $1;
            }
            
            root /usr/local/www/arturo/main/versions;
            add_header X-Served-By "Local-Fallback" always;
            try_files /latest/files/$filename =404;
        }

        ######################################
        ## PHP & Playground
        ######################################
        
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
        }
        
        location ~ ^/([^/]+)/playground/([a-zA-Z0-9]+)$ {
            try_files /$1/playground/index.html =404;
        }
        
        ######################################
        ## Version paths
        ######################################
        
        location ~ ^/(test|latest|stable|v[0-9.]+)$ {
            return 301 $scheme://$host$uri/;
        }
        
        location ~ ^/(latest|stable|v[0-9.]+)/ {
            error_page 404 /$1/error/404/index.html;
        }
        
        location ~ ^/([^/]+)/error/404/index\.html$ {
            internal;
        }
        
        ######################################
        ## Static assets caching
        ######################################
        
        location ~* \.(jpg|jpeg|png|webp|gif|ico)$ {
            expires 30d;
        }
        
        location ~* \.(css|js)$ {
            expires 7d;
        }
        
        ######################################
        ## Default handler
        ######################################
        
        location / {
            error_page 404 /stable/error/404/index.html;
            try_files $uri $uri/index.html /stable$uri /stable$uri/index.html =404;
        }
    }
}